<div class="max-w-7xl mx-auto">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Activity Posts Management</h1>
    <p class="mt-2 text-gray-600">Review and manage all activity posts on the platform.</p>
  </div>

  <!-- Search and Filter -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <div class="flex flex-col md:flex-row gap-4">
      <div class="flex-1">
        <input
          type="text"
          id="activity-search"
          placeholder="Search activity posts by title, location, or owner..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
        >
      </div>
      <div class="flex gap-2">
        <button onclick="loadActivities()" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
          <i data-lucide="search" class="w-4 h-4 inline mr-2"></i>
          Search
        </button>
      </div>
    </div>
  </div>

  <!-- Activity Posts Table -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Activity Posts (<span id="activity-count">0</span>)</h2>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Posted</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="activity-table-body" class="bg-white divide-y divide-gray-200">
          <!-- Activity posts will be loaded dynamically -->
        </tbody>
      </table>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="px-6 py-12 text-center">
      <div class="inline-flex items-center">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-orange-600 mr-3"></div>
        <span class="text-gray-600">Loading activity posts...</span>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden px-6 py-12 text-center">
      <i data-lucide="calendar" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No activity posts found</h3>
      <p class="text-gray-600">Try adjusting your search criteria.</p>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full p-6">
    <div class="flex items-center mb-4">
      <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-900">Delete Activity Post</h3>
    </div>
    <p class="text-gray-600 mb-6">
      Are you sure you want to delete "<span id="delete-title" class="font-medium"></span>"?
      This action cannot be undone.
    </p>
    <div class="flex gap-3">
      <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
        Cancel
      </button>
      <button id="confirm-delete" onclick="confirmDeleteActivity()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
        Delete Post
      </button>
    </div>
  </div>
</div>

<script>
let currentActivities = [];
let itemToDelete = null;

// Load activity posts with optional search
async function loadActivities(search = '') {
  const loadingState = document.getElementById('loading-state');
  const emptyState = document.getElementById('empty-state');
  const tableBody = document.getElementById('activity-table-body');

  loadingState.classList.remove('hidden');
  emptyState.classList.add('hidden');
  tableBody.innerHTML = '';

  try {
    const response = await fetch('/api/admin/buddies', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    if (response.ok) {
      const data = await response.json();
      currentActivities = data.buddies || [];

      // Apply filters
      let filteredActivities = currentActivities;
      if (search) {
        const searchLower = search.toLowerCase();
        filteredActivities = filteredActivities.filter(activity =>
          activity.activity_name.toLowerCase().includes(searchLower) ||
          activity.location.toLowerCase().includes(searchLower) ||
          activity.owner_username.toLowerCase().includes(searchLower)
        );
      }

      displayActivities(filteredActivities);
    } else {
      console.error('Failed to load activity posts');
      showError('Failed to load activity posts');
    }
  } catch (error) {
    console.error('Error loading activity posts:', error);
    showError('Error loading activity posts');
  }

  loadingState.classList.add('hidden');
}

// Display activity posts in table
function displayActivities(activities) {
  const tableBody = document.getElementById('activity-table-body');
  const emptyState = document.getElementById('empty-state');
  const activityCount = document.getElementById('activity-count');

  activityCount.textContent = activities.length;

  if (activities.length === 0) {
    emptyState.classList.remove('hidden');
    return;
  }

  emptyState.classList.add('hidden');

  tableBody.innerHTML = activities.map(item => `
    <tr class="hover:bg-gray-50">
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center mr-3">
            <i data-lucide="calendar" class="w-6 h-6 text-gray-600"></i>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-900">${item.activity_name}</div>
            <div class="text-sm text-gray-500">${item.activity_type || 'Activity'}</div>
          </div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.location}</td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
        <div>${item.activity_date ? new Date(item.activity_date).toLocaleDateString() : 'N/A'}</div>
        <div class="text-gray-500">${item.activity_time || ''}</div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.owner_username}</td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        ${new Date(item.created_at).toLocaleDateString()}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
        <button onclick="showDeleteModal(${item.id}, '${item.activity_name.replace(/'/g, "\\'")}')"
                class="text-red-600 hover:text-red-900 transition-colors">
          <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
          Delete
        </button>
      </td>
    </tr>
  `).join('');

  // Re-initialize icons
  lucide.createIcons();
}

// Show delete confirmation modal
function showDeleteModal(activityId, title) {
  itemToDelete = activityId;
  document.getElementById('delete-title').textContent = title;
  document.getElementById('delete-modal').classList.remove('hidden');
}

// Close delete modal
function closeDeleteModal() {
  itemToDelete = null;
  document.getElementById('delete-modal').classList.add('hidden');
}

// Confirm and delete activity post
async function confirmDeleteActivity() {
  if (!itemToDelete) return;

  try {
    const response = await fetch(`/api/admin/buddies/${itemToDelete}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    if (response.ok) {
      closeDeleteModal();
      // Reload activity posts
      const searchInput = document.getElementById('activity-search').value;
      loadActivities(searchInput);
      showSuccess('Activity post deleted successfully');
    } else {
      const error = await response.json();
      showError(error.message || 'Failed to delete activity post');
    }
  } catch (error) {
    console.error('Error deleting activity post:', error);
    showError('Error deleting activity post');
  }
}

// Utility functions for notifications
function showSuccess(message) {
  alert(message);
}

function showError(message) {
  alert('Error: ' + message);
}

// Event listeners
document.getElementById('activity-search').addEventListener('input', function() {
  const search = this.value;
  loadActivities(search);
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  loadActivities();
});
</script>
