<div class="max-w-7xl mx-auto">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Housing Posts Management</h1>
    <p class="mt-2 text-gray-600">Review and manage all housing listings on the platform.</p>
  </div>

  <!-- Search and Filter -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <div class="flex flex-col md:flex-row gap-4">
      <div class="flex-1">
        <input
          type="text"
          id="housing-search"
          placeholder="Search housing by title, location, or owner..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
        >
      </div>
      <div class="flex gap-2">
        <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
          <option value="">All Status</option>
          <option value="available">Available</option>
          <option value="rented">Rented</option>
        </select>
        <button onclick="loadHousing()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
          <i data-lucide="search" class="w-4 h-4 inline mr-2"></i>
          Search
        </button>
      </div>
    </div>
  </div>

  <!-- Housing Posts Table -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Housing Posts (<span id="housing-count">0</span>)</h2>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Posted</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="housing-table-body" class="bg-white divide-y divide-gray-200">
          <!-- Housing posts will be loaded dynamically -->
        </tbody>
      </table>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="px-6 py-12 text-center">
      <div class="inline-flex items-center">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600 mr-3"></div>
        <span class="text-gray-600">Loading housing posts...</span>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden px-6 py-12 text-center">
      <i data-lucide="home" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No housing posts found</h3>
      <p class="text-gray-600">Try adjusting your search criteria.</p>
    </div>
  </div>

  <!-- Pagination -->
  <div id="pagination" class="mt-6 flex justify-center">
    <!-- Pagination will be added dynamically -->
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full p-6">
    <div class="flex items-center mb-4">
      <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-900">Delete Housing Post</h3>
    </div>
    <p class="text-gray-600 mb-6">
      Are you sure you want to delete "<span id="delete-title" class="font-medium"></span>"?
      This action cannot be undone.
    </p>
    <div class="flex gap-3">
      <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
        Cancel
      </button>
      <button id="confirm-delete" onclick="confirmDeleteHousing()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
        Delete Post
      </button>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-900">Housing Details</h3>
        <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div id="housing-details" class="space-y-4">
        <!-- Housing details will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
let currentHousing = [];
let itemToDelete = null;

// Load housing posts with optional search and filter
async function loadHousing(search = '', status = '') {
  const loadingState = document.getElementById('loading-state');
  const emptyState = document.getElementById('empty-state');
  const tableBody = document.getElementById('housing-table-body');

  loadingState.classList.remove('hidden');
  emptyState.classList.add('hidden');
  tableBody.innerHTML = '';

  try {
    const response = await fetch('/api/admin/housing', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    if (response.ok) {
      const data = await response.json();
      currentHousing = data.housing || [];

      // Apply filters
      let filteredHousing = currentHousing;
      if (search) {
        const searchLower = search.toLowerCase();
        filteredHousing = filteredHousing.filter(housing =>
          housing.title.toLowerCase().includes(searchLower) ||
          housing.location.toLowerCase().includes(searchLower) ||
          housing.owner_username.toLowerCase().includes(searchLower)
        );
      }

      displayHousing(filteredHousing);
    } else {
      console.error('Failed to load housing posts');
      showError('Failed to load housing posts');
    }
  } catch (error) {
    console.error('Error loading housing posts:', error);
    showError('Error loading housing posts');
  }

  loadingState.classList.add('hidden');
}

// Display housing posts in table
function displayHousing(housing) {
  const tableBody = document.getElementById('housing-table-body');
  const emptyState = document.getElementById('empty-state');
  const housingCount = document.getElementById('housing-count');

  housingCount.textContent = housing.length;

  if (housing.length === 0) {
    emptyState.classList.remove('hidden');
    return;
  }

  emptyState.classList.add('hidden');

  tableBody.innerHTML = housing.map(item => `
    <tr class="hover:bg-gray-50">
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center mr-3">
            <i data-lucide="home" class="w-6 h-6 text-gray-600"></i>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-900">${item.title}</div>
            <div class="text-sm text-gray-500">${item.property_type || 'N/A'}</div>
          </div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.location}</td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">$${item.rent_amount}/month</td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.owner_username}</td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        ${new Date(item.created_at).toLocaleDateString()}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
        <button onclick="viewHousingDetails(${item.id})"
                class="text-blue-600 hover:text-blue-900 transition-colors">
          <i data-lucide="eye" class="w-4 h-4 inline mr-1"></i>
          View
        </button>
        <button onclick="showDeleteModal(${item.id}, '${item.title.replace(/'/g, "\\'")}')"
                class="text-red-600 hover:text-red-900 transition-colors">
          <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
          Delete
        </button>
      </td>
    </tr>
  `).join('');

  // Re-initialize icons
  lucide.createIcons();
}

// View housing details
async function viewHousingDetails(housingId) {
  try {
    const response = await fetch(`/api/housing/${housingId}`);
    if (response.ok) {
      const housing = await response.json();
      displayHousingDetails(housing);
      document.getElementById('details-modal').classList.remove('hidden');
    } else {
      showError('Failed to load housing details');
    }
  } catch (error) {
    console.error('Error loading housing details:', error);
    showError('Error loading housing details');
  }
}

// Display housing details in modal
function displayHousingDetails(housing) {
  const detailsContainer = document.getElementById('housing-details');

  detailsContainer.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h4 class="font-semibold text-gray-900 mb-2">Basic Information</h4>
        <div class="space-y-2 text-sm">
          <p><span class="font-medium">Title:</span> ${housing.title}</p>
          <p><span class="font-medium">Location:</span> ${housing.location}</p>
          <p><span class="font-medium">Rent:</span> $${housing.rent_amount}/month</p>
          <p><span class="font-medium">Property Type:</span> ${housing.property_type || 'N/A'}</p>
          <p><span class="font-medium">Bedrooms:</span> ${housing.bedrooms || 'N/A'}</p>
          <p><span class="font-medium">Bathrooms:</span> ${housing.bathrooms || 'N/A'}</p>
          <p><span class="font-medium">Owner:</span> ${housing.owner_username}</p>
          <p><span class="font-medium">Posted:</span> ${new Date(housing.created_at).toLocaleString()}</p>
        </div>
      </div>
      <div>
        <h4 class="font-semibold text-gray-900 mb-2">Description</h4>
        <p class="text-sm text-gray-700">${housing.description || 'No description provided.'}</p>

        <h4 class="font-semibold text-gray-900 mb-2 mt-4">Amenities</h4>
        <div class="text-sm text-gray-700">
          ${housing.amenities ? housing.amenities.split(',').map(amenity => `<span class="inline-block bg-gray-100 px-2 py-1 rounded mr-1 mb-1">${amenity.trim()}</span>`).join('') : 'No amenities listed.'}
        </div>
      </div>
    </div>
  `;
}

// Show delete confirmation modal
function showDeleteModal(housingId, title) {
  itemToDelete = housingId;
  document.getElementById('delete-title').textContent = title;
  document.getElementById('delete-modal').classList.remove('hidden');
}

// Close delete modal
function closeDeleteModal() {
  itemToDelete = null;
  document.getElementById('delete-modal').classList.add('hidden');
}

// Close details modal
function closeDetailsModal() {
  document.getElementById('details-modal').classList.add('hidden');
}

// Confirm and delete housing post
async function confirmDeleteHousing() {
  if (!itemToDelete) return;

  try {
    const response = await fetch(`/api/admin/housing/${itemToDelete}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    if (response.ok) {
      closeDeleteModal();
      // Reload housing posts
      const searchInput = document.getElementById('housing-search').value;
      const statusFilter = document.getElementById('status-filter').value;
      loadHousing(searchInput, statusFilter);
      showSuccess('Housing post deleted successfully');
    } else {
      const error = await response.json();
      showError(error.message || 'Failed to delete housing post');
    }
  } catch (error) {
    console.error('Error deleting housing post:', error);
    showError('Error deleting housing post');
  }
}

// Utility functions for notifications
function showSuccess(message) {
  alert(message);
}

function showError(message) {
  alert('Error: ' + message);
}

// Event listeners
document.getElementById('housing-search').addEventListener('input', function() {
  const search = this.value;
  const status = document.getElementById('status-filter').value;
  loadHousing(search, status);
});

document.getElementById('status-filter').addEventListener('change', function() {
  const search = document.getElementById('housing-search').value;
  const status = this.value;
  loadHousing(search, status);
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  loadHousing();
});
</script>
