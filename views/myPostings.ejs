<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Postings - Bachelor Society</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="/js/auth.js"></script>
    <style>
      .sidebar-transition {
        transition: transform 0.3s ease-in-out;
      }
      .nav-item {
        transition: all 0.2s ease-in-out;
      }
      .nav-item.active {
        background-color: rgba(59, 130, 246, 0.1);
        border-left: 3px solid #3b82f6;
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans">
    <!-- Include Sidebar -->
    <%- include('partials/sidebar') %>

    <!-- Main Content -->
    <div class="lg:ml-80 min-h-screen">
      <!-- Top Bar (Mobile) -->
      <div class="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-3 flex items-center justify-between">
        <button onclick="toggleSidebar()" class="text-gray-600 hover:text-gray-800">
          <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <h1 class="text-lg font-semibold text-gray-800">My Postings</h1>
        <div class="w-6"></div> <!-- Spacer -->
      </div>

      <!-- Page Content -->
      <div class="p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">My Postings</h2>
          </div>

          <!-- Tabs for different types -->
          <div class="mb-6">
            <div class="border-b border-gray-200">
              <nav class="-mb-px flex space-x-8">
                <button id="housingTab" class="tab-button active border-blue-500 text-blue-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                  Housing Listings
                </button>
                <button id="roommateTab" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                  Roommate Requests
                </button>
                <button id="activityTab" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                  Activities
                </button>
              </nav>
            </div>
          </div>

          <!-- Content Areas -->
          <div id="housingPosts" class="post-section">
            <div id="housingContent" class="grid grid-cols-1 gap-6"></div>
            <div id="housingLoading" class="text-center py-12">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
              <p class="mt-2 text-gray-600">Loading your housing listings...</p>
            </div>
          </div>

          <div id="roommatePosts" class="post-section hidden">
            <div id="roommateContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="roommateLoading" class="text-center py-12">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
              <p class="mt-2 text-gray-600">Loading your roommate requests...</p>
            </div>
          </div>

          <div id="activityPosts" class="post-section hidden">
            <div id="activityContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="activityLoading" class="text-center py-12">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
              <p class="mt-2 text-gray-600">Loading your activities...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize Lucide icons
      lucide.createIcons();

      // Sidebar toggle for mobile
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        if (sidebar.classList.contains('-translate-x-full')) {
          sidebar.classList.remove('-translate-x-full');
          overlay.classList.remove('hidden');
        } else {
          sidebar.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
        }
      }

      // Navigation
      document.addEventListener('DOMContentLoaded', function() {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
          const href = item.getAttribute('href');
          if (href === currentPath || (href !== '/dashboard' && currentPath.startsWith(href))) {
            item.classList.add('active');
          }
        });

        // Load initial data
        loadHousingPosts();
      });

      // Tab switching
      document.getElementById('housingTab').addEventListener('click', function() {
        switchTab('housing');
        loadHousingPosts();
      });
      document.getElementById('roommateTab').addEventListener('click', function() {
        switchTab('roommate');
        loadRoommatePosts();
      });
      document.getElementById('activityTab').addEventListener('click', function() {
        switchTab('activity');
        loadActivityPosts();
      });

      function switchTab(activeTab) {
        // Hide all sections
        document.querySelectorAll('.post-section').forEach(section => section.classList.add('hidden'));

        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(tab => {
          tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
          tab.classList.add('border-transparent', 'text-gray-500');
        });

        // Show active section and tab
        document.getElementById(activeTab + 'Posts').classList.remove('hidden');
        document.getElementById(activeTab + 'Tab').classList.add('active', 'border-blue-500', 'text-blue-600');
        document.getElementById(activeTab + 'Tab').classList.remove('border-transparent', 'text-gray-500');
      }

      async function loadHousingPosts() {
        const loading = document.getElementById('housingLoading');
        const content = document.getElementById('housingContent');

        loading.classList.remove('hidden');
        content.innerHTML = '';

        try {
          const response = await fetch('/api/housing?owner=true');
          const data = await response.json();

          loading.classList.add('hidden');

          if (data.listings && data.listings.length > 0) {
            renderHousingPosts(data.listings);
          } else {
            content.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500">You haven\'t posted any housing listings yet.</p><a href="/housing/create" class="text-blue-600 hover:text-blue-800">Create your first listing</a></div>';
          }
        } catch (error) {
          loading.classList.add('hidden');
          content.innerHTML = '<div class="col-span-full text-center py-12 text-red-600">Error loading your posts</div>';
        }
      }

      async function loadRoommatePosts() {
        const loading = document.getElementById('roommateLoading');
        const content = document.getElementById('roommateContent');

        loading.classList.remove('hidden');
        content.innerHTML = '';

        try {
          // Get token from localStorage for authentication
          const token = localStorage.getItem('token');
          const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

          const response = await fetch('/api/roommates?owner=true', { headers });
          const data = await response.json();

          loading.classList.add('hidden');

          if (data && data.listings && data.listings.length > 0) {
            renderRoommatePosts(data.listings);
          } else {
            content.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500">You haven\'t created any roommate requests yet.</p><a href="/roommates/create" class="text-blue-600 hover:text-blue-800">Create your first request</a></div>';
          }
        } catch (error) {
          loading.classList.add('hidden');
          content.innerHTML = '<div class="col-span-full text-center py-12 text-red-600">Error loading your posts</div>';
        }
      }

      async function loadActivityPosts() {
        const loading = document.getElementById('activityLoading');
        const content = document.getElementById('activityContent');

        loading.classList.remove('hidden');
        content.innerHTML = '';

        try {
          // Get token from localStorage for authentication
          const token = localStorage.getItem('token');
          const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

          const response = await fetch('/api/buddies?owner=true', { headers });
          const data = await response.json();

          loading.classList.add('hidden');

          if (data.buddies && data.buddies.length > 0) {
            renderActivityPosts(data.buddies);
          } else {
            content.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500">You haven\'t created any activities yet.</p><a href="/buddies/create" class="text-purple-600 hover:text-purple-800">Create your first activity</a></div>';
          }
        } catch (error) {
          loading.classList.add('hidden');
          content.innerHTML = '<div class="col-span-full text-center py-12 text-red-600">Error loading your posts</div>';
        }
      }

      function renderHousingPosts(posts) {
        const container = document.getElementById('housingContent');
        posts.forEach(post => {
          const div = document.createElement('div');
          div.className = 'bg-white rounded-lg shadow-md p-4';
          div.innerHTML = `
            <h3 class="font-semibold">${post.property_type} - ${post.rooms} rooms</h3>
            <p class="text-sm text-gray-600">${post.address}</p>
            <p class="text-sm text-gray-600">$${post.rent} per month</p>
            <div class="flex flex-wrap gap-3">
              <a href="/housing/${post.id}/view" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium whitespace-nowrap">
                View Details
              </a>
              <a href="/housing/${post.id}/edit" class="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 transition-colors text-sm font-medium whitespace-nowrap">
                Edit
              </a>
              <button onclick="deletePost('housing', ${post.id})" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors text-sm font-medium whitespace-nowrap">
                Delete
              </button>
            </div>
          `;
          container.appendChild(div);
        });
      }

      function renderRoommatePosts(posts) {
        const container = document.getElementById('roommateContent');
        posts.forEach(post => {
          const div = document.createElement('div');
          div.className = 'bg-white rounded-lg shadow-md p-4';
          div.innerHTML = `
            <h3 class="font-semibold">${post.preferred_location}</h3>
            <p class="text-sm text-gray-600">$${post.budget_min} - $${post.budget_max} per month</p>
            <p class="text-sm text-gray-600">${post.room_type || 'Any room type'}</p>
            <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.75rem;">
              <a href="/roommates/${post.id}/view" style="background-color: #16a34a; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; display: inline-block; font-size: 0.875rem; font-weight: 500;">
                View Details
              </a>
              <a href="/roommates/${post.id}/edit" style="background-color: #d97706; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; display: inline-block; font-size: 0.875rem; font-weight: 500;">
                Edit
              </a>
              <button onclick="deletePost('roommate', ${post.id})" style="background-color: #dc2626; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                Delete
              </button>
            </div>
          `;
          container.appendChild(div);
        });
      }

      function renderActivityPosts(posts) {
        const container = document.getElementById('activityContent');
        posts.forEach(post => {
          const div = document.createElement('div');
          div.className = 'bg-white rounded-lg shadow-md p-4';
          div.innerHTML = `
            <h3 class="font-semibold">${post.activity_type}</h3>
            <p class="text-sm text-gray-600">${post.location}</p>
            <p class="text-sm text-gray-600">${new Date(post.date_time).toLocaleDateString()}</p>
            <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.75rem;">
              <a href="/buddies/${post.id}/view" style="background-color: #7c3aed; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; display: inline-block; font-size: 0.875rem; font-weight: 500;">
                View Details
              </a>
              <a href="/buddies/${post.id}/edit" style="background-color: #d97706; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; display: inline-block; font-size: 0.875rem; font-weight: 500;">
                Edit
              </a>
              <button onclick="deletePost('activity', ${post.id})" style="background-color: #dc2626; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                Delete
              </button>
            </div>
          `;
          container.appendChild(div);
        });
      }

      async function deletePost(type, id) {
        if (!confirm('Are you sure you want to delete this post?')) return;

        try {
          let endpoint = '';
          if (type === 'housing') endpoint = `/api/housing/${id}`;
          else if (type === 'roommate') endpoint = `/api/roommates/${id}`;
          else if (type === 'activity') endpoint = `/api/buddies/${id}`;

          const response = await fetch(endpoint, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });

          if (response.ok) {
            // Reload current tab
            if (type === 'housing' && document.getElementById('housingPosts').classList.contains('hidden') === false) {
              loadHousingPosts();
            } else if (type === 'roommate' && document.getElementById('roommatePosts').classList.contains('hidden') === false) {
              loadRoommatePosts();
            } else if (type === 'activity' && document.getElementById('activityPosts').classList.contains('hidden') === false) {
              loadActivityPosts();
            }
          } else {
            alert('Failed to delete post');
          }
        } catch (error) {
          alert('Error deleting post');
        }
      }
    </script>
  </body>
</html>
