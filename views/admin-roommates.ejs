<div class="max-w-7xl mx-auto">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Roommate Posts Management</h1>
    <p class="mt-2 text-gray-600">Review and manage all roommate requests on the platform.</p>
  </div>

  <!-- Search and Filter -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <div class="flex flex-col md:flex-row gap-4">
      <div class="flex-1">
        <input
          type="text"
          id="roommate-search"
          placeholder="Search roommate posts by title, location, or owner..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
        >
      </div>
      <div class="flex gap-2">
        <button onclick="loadRoommates()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
          <i data-lucide="search" class="w-4 h-4 inline mr-2"></i>
          Search
        </button>
      </div>
    </div>
  </div>

  <!-- Roommate Posts Table -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Roommate Posts (<span id="roommate-count">0</span>)</h2>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Posted</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="roommate-table-body" class="bg-white divide-y divide-gray-200">
          <!-- Roommate posts will be loaded dynamically -->
        </tbody>
      </table>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="px-6 py-12 text-center">
      <div class="inline-flex items-center">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600 mr-3"></div>
        <span class="text-gray-600">Loading roommate posts...</span>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden px-6 py-12 text-center">
      <i data-lucide="user-plus" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No roommate posts found</h3>
      <p class="text-gray-600">Try adjusting your search criteria.</p>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full p-6">
    <div class="flex items-center mb-4">
      <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-900">Delete Roommate Post</h3>
    </div>
    <p class="text-gray-600 mb-6">
      Are you sure you want to delete "<span id="delete-title" class="font-medium"></span>"?
      This action cannot be undone.
    </p>
    <div class="flex gap-3">
      <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
        Cancel
      </button>
      <button id="confirm-delete" onclick="confirmDeleteRoommate()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
        Delete Post
      </button>
    </div>
  </div>
</div>

<script>
let currentRoommates = [];
let itemToDelete = null;

// Load roommate posts with optional search
async function loadRoommates(search = '') {
  const loadingState = document.getElementById('loading-state');
  const emptyState = document.getElementById('empty-state');
  const tableBody = document.getElementById('roommate-table-body');

  loadingState.classList.remove('hidden');
  emptyState.classList.add('hidden');
  tableBody.innerHTML = '';

  try {
    const response = await fetch('/api/admin/roommates', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    if (response.ok) {
      const data = await response.json();
      currentRoommates = data.roommates || [];

      // Apply filters
      let filteredRoommates = currentRoommates;
      if (search) {
        const searchLower = search.toLowerCase();
        filteredRoommates = filteredRoommates.filter(roommate =>
          roommate.title.toLowerCase().includes(searchLower) ||
          roommate.location.toLowerCase().includes(searchLower) ||
          roommate.owner_username.toLowerCase().includes(searchLower)
        );
      }

      displayRoommates(filteredRoommates);
    } else {
      console.error('Failed to load roommate posts');
      showError('Failed to load roommate posts');
    }
  } catch (error) {
    console.error('Error loading roommate posts:', error);
    showError('Error loading roommate posts');
  }

  loadingState.classList.add('hidden');
}

// Display roommate posts in table
function displayRoommates(roommates) {
  const tableBody = document.getElementById('roommate-table-body');
  const emptyState = document.getElementById('empty-state');
  const roommateCount = document.getElementById('roommate-count');

  roommateCount.textContent = roommates.length;

  if (roommates.length === 0) {
    emptyState.classList.remove('hidden');
    return;
  }

  emptyState.classList.add('hidden');

  tableBody.innerHTML = roommates.map(item => `
    <tr class="hover:bg-gray-50">
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center mr-3">
            <i data-lucide="user-plus" class="w-6 h-6 text-gray-600"></i>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-900">${item.title}</div>
            <div class="text-sm text-gray-500">${item.looking_for || 'Roommate request'}</div>
          </div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.location}</td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
        ${item.budget_min && item.budget_max ? `$${item.budget_min} - $${item.budget_max}` : 'N/A'}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.owner_username}</td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        ${new Date(item.created_at).toLocaleDateString()}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
        <button onclick="showDeleteModal(${item.id}, '${item.title.replace(/'/g, "\\'")}')"
                class="text-red-600 hover:text-red-900 transition-colors">
          <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
          Delete
        </button>
      </td>
    </tr>
  `).join('');

  // Re-initialize icons
  lucide.createIcons();
}

// Show delete confirmation modal
function showDeleteModal(roommateId, title) {
  itemToDelete = roommateId;
  document.getElementById('delete-title').textContent = title;
  document.getElementById('delete-modal').classList.remove('hidden');
}

// Close delete modal
function closeDeleteModal() {
  itemToDelete = null;
  document.getElementById('delete-modal').classList.add('hidden');
}

// Confirm and delete roommate post
async function confirmDeleteRoommate() {
  if (!itemToDelete) return;

  try {
    const response = await fetch(`/api/admin/roommates/${itemToDelete}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    if (response.ok) {
      closeDeleteModal();
      // Reload roommate posts
      const searchInput = document.getElementById('roommate-search').value;
      loadRoommates(searchInput);
      showSuccess('Roommate post deleted successfully');
    } else {
      const error = await response.json();
      showError(error.message || 'Failed to delete roommate post');
    }
  } catch (error) {
    console.error('Error deleting roommate post:', error);
    showError('Error deleting roommate post');
  }
}

// Utility functions for notifications
function showSuccess(message) {
  alert(message);
}

function showError(message) {
  alert('Error: ' + message);
}

// Event listeners
document.getElementById('roommate-search').addEventListener('input', function() {
  const search = this.value;
  loadRoommates(search);
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  loadRoommates();
});
</script>
