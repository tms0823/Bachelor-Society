<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Profile - Bachelor Society</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="/js/auth.js"></script>
    <style>
      .sidebar-transition {
        transition: transform 0.3s ease-in-out;
      }
      .nav-item {
        transition: all 0.2s ease-in-out;
      }
      .nav-item.active {
        background-color: rgba(59, 130, 246, 0.1);
        border-left: 3px solid #3b82f6;
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans">
    <!-- Include Sidebar -->
    <%- include('partials/sidebar') %>

    <!-- Main Content -->
    <div class="lg:ml-80 min-h-screen">
      <!-- Top Bar (Mobile) -->
      <div class="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-3 flex items-center justify-between">
        <button onclick="toggleSidebar()" class="text-gray-600 hover:text-gray-800">
          <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <h1 class="text-lg font-semibold text-gray-800">My Profile</h1>
        <div class="w-6"></div> <!-- Spacer -->
      </div>

      <!-- Page Content -->
      <div class="p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
          <!-- Edit Profile Section -->
          <div id="profileSection" class="<%= (typeof tab === 'undefined' || tab === 'edit') ? '' : 'hidden' %>">
            <div class="max-w-4xl mx-auto">
              <div class="bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Edit Profile</h2>

                <!-- Profile Picture Section -->
                <div class="mb-8">
                  <div class="flex items-center space-x-6">
                    <div class="relative">
                      <% if (user.profile_picture) { %>
                        <img src="<%= user.profile_picture %>" alt="Profile Picture" class="w-24 h-24 rounded-full object-cover border-4 border-gray-200">
                      <% } else { %>
                        <div class="w-24 h-24 rounded-full bg-gray-300 flex items-center justify-center border-4 border-gray-200">
                          <svg class="w-12 h-12 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                          </svg>
                        </div>
                      <% } %>
                      <button type="button" id="changePhotoBtn" class="absolute bottom-0 right-0 bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                      </button>
                    </div>
                    <div>
                      <h3 class="text-lg font-semibold text-gray-800">Profile Picture</h3>
                      <p class="text-sm text-gray-600">Upload a new profile picture</p>
                      <input type="file" id="profilePictureInput" name="profilePicture" accept="image/*" class="hidden">
                    </div>
                  </div>
                </div>

                <!-- Profile Information -->
                <form id="profileForm" class="space-y-6">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                      <input type="text" id="username" name="username" value="<%= user.username %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                      <input type="email" id="email" name="email" value="<%= user.email || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                      <input type="tel" id="phone" name="phone" value="<%= user.phone || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="flex justify-end space-x-4">
                    <button type="button" id="editBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                      Edit Profile
                    </button>
                    <div id="saveCancelBtns" class="hidden space-x-4">
                      <button type="button" id="cancelBtn" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                        Cancel
                      </button>
                      <button type="submit" id="saveBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                        Save Changes
                      </button>
                    </div>
                  </div>

                  <!-- Status Message -->
                  <div id="statusMessage" class="hidden p-4 rounded-md"></div>
                </form>
              </div>
            </div>
          </div>

          <!-- My Posts Section -->
          <div id="postsSection" class="<%= (typeof tab !== 'undefined' && tab === 'posts') ? '' : 'hidden' %>">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-3xl font-bold text-gray-800">My Posts</h2>
            </div>

            <!-- All Posts Container -->
            <div id="allPostsContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize Lucide icons
      lucide.createIcons();

      // Sidebar toggle for mobile
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        if (sidebar.classList.contains('-translate-x-full')) {
          sidebar.classList.remove('-translate-x-full');
          overlay.classList.remove('hidden');
        } else {
          sidebar.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
        }
      }

      // Navigation
      document.addEventListener('DOMContentLoaded', function() {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
          const href = item.getAttribute('href');
          if (href === currentPath || (href !== '/dashboard' && currentPath.startsWith(href))) {
            item.classList.add('active');
          }
        });

        // Load all posts when posts section is shown
        if (window.location.search.includes('tab=posts')) {
          loadAllPosts();
        }

        // Profile editing functionality
        const editBtn = document.getElementById('editBtn');
        const saveCancelBtns = document.getElementById('saveCancelBtns');
        const cancelBtn = document.getElementById('cancelBtn');
        const profileForm = document.getElementById('profileForm');
        const statusMessage = document.getElementById('statusMessage');
        const changePhotoBtn = document.getElementById('changePhotoBtn');
        const profilePictureInput = document.getElementById('profilePictureInput');

        let originalValues = {};

        // Profile picture change functionality
        changePhotoBtn.addEventListener('click', function() {
          profilePictureInput.click();
        });

        profilePictureInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            // Preview the selected image
            const reader = new FileReader();
            reader.onload = function(e) {
              const img = document.querySelector('.relative img') || document.querySelector('.relative div');
              if (img.tagName === 'IMG') {
                img.src = e.target.result;
              } else {
                // Replace the placeholder div with an img element
                const newImg = document.createElement('img');
                newImg.src = e.target.result;
                newImg.alt = 'Profile Picture Preview';
                newImg.className = 'w-24 h-24 rounded-full object-cover border-4 border-gray-200';
                img.parentNode.replaceChild(newImg, img);
              }
            };
            reader.readAsDataURL(file);
          }
        });

        // Store original values when page loads
        function storeOriginalValues() {
          const inputs = profileForm.querySelectorAll('input, select, textarea');
          inputs.forEach(input => {
            if (input.name) {
              originalValues[input.name] = input.value;
            }
          });
        }

        // No location selector needed for basic profile fields

        // Enable editing mode
        editBtn.addEventListener('click', function() {
          storeOriginalValues();

          // Make fields editable
          const inputs = profileForm.querySelectorAll('input:not([name="username"]), select, textarea');
          inputs.forEach(input => {
            input.removeAttribute('readonly');
            input.removeAttribute('disabled');
          });

          // Show save/cancel buttons, hide edit button
          editBtn.classList.add('hidden');
          saveCancelBtns.classList.remove('hidden');
        });

        // Cancel editing
        cancelBtn.addEventListener('click', function() {
          // Restore original values
          Object.keys(originalValues).forEach(name => {
            const input = profileForm.querySelector(`[name="${name}"]`);
            if (input) {
              input.value = originalValues[name];
            }
          });

          // Make fields readonly again
          const inputs = profileForm.querySelectorAll('input, select, textarea');
          inputs.forEach(input => {
            if (input.name !== 'username') {
              input.setAttribute('readonly', 'readonly');
              if (input.tagName === 'SELECT') {
                input.setAttribute('disabled', 'disabled');
              }
            }
          });

          // Hide save/cancel buttons, show edit button
          editBtn.classList.remove('hidden');
          saveCancelBtns.classList.add('hidden');

          // Hide status message
          statusMessage.classList.add('hidden');
        });

        // Save profile changes
        profileForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const saveBtn = document.getElementById('saveBtn');
          const originalHTML = saveBtn.innerHTML;
          const originalClasses = saveBtn.className;

          // Show loading state
          saveBtn.innerHTML = '<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
          saveBtn.disabled = true;
          saveBtn.className = 'bg-green-600 text-white px-8 py-4 rounded-lg font-medium transform scale-110 transition-all duration-300';

          try {
            // Get token from localStorage
            const token = localStorage.getItem('token');
            if (!token) {
              throw new Error('Not authenticated');
            }

            // Check if we have a profile picture file
            const profilePictureFile = profilePictureInput.files[0];
            let response;

            if (profilePictureFile) {
              // Send as FormData for file upload
              const formData = new FormData();
              formData.append('profilePicture', profilePictureFile);

              // Add other form fields
              const inputs = profileForm.querySelectorAll('input[name], select[name], textarea[name]');
              inputs.forEach(input => {
                if (input.name && input.name !== 'profilePicture' && input.value.trim() !== '') {
                  formData.append(input.name, input.value);
                }
              });

              response = await fetch('/api/users/me', {
                method: 'PUT',
                headers: {
                  'Authorization': `Bearer ${token}`
                },
                body: formData
              });
            } else {
              // Send as JSON for text-only updates
              const data = {};
              const inputs = profileForm.querySelectorAll('input[name], select[name], textarea[name]');
              inputs.forEach(input => {
                if (input.name && input.value.trim() !== '') {
                  data[input.name] = input.value;
                }
              });

              response = await fetch('/api/users/me', {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
              });
            }

            const result = await response.json();

            if (response.ok) {
              // Success! Transform button to show checkmark
              saveBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
              saveBtn.className = 'bg-green-600 text-white px-8 py-4 rounded-lg font-medium transform scale-110 transition-all duration-300 shadow-lg';

              // Update original values
              storeOriginalValues();

              // Make fields readonly again
              const inputs = profileForm.querySelectorAll('input, select, textarea');
              inputs.forEach(input => {
                if (input.name !== 'username') {
                  input.setAttribute('readonly', 'readonly');
                  if (input.tagName === 'SELECT') {
                    input.setAttribute('disabled', 'disabled');
                  }
                }
              });

              // Hide save/cancel buttons and show edit button immediately
              setTimeout(() => {
                editBtn.classList.remove('hidden');
                saveCancelBtns.classList.add('hidden');
                saveBtn.innerHTML = 'Save Changes';
                saveBtn.className = 'bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium';
                saveBtn.disabled = false;
              }, 500);

            } else {
              // Error - revert button and show error
              saveBtn.innerHTML = originalHTML;
              saveBtn.className = originalClasses;
              saveBtn.disabled = false;

              statusMessage.className = 'p-4 rounded-md text-red-700 bg-red-50 border border-red-200';
              statusMessage.textContent = result.message || 'Failed to update profile';
              statusMessage.classList.remove('hidden');
            }

          } catch (error) {
            console.error('Error updating profile:', error);

            // Error - revert button and show error
            saveBtn.innerHTML = originalHTML;
            saveBtn.className = originalClasses;
            saveBtn.disabled = false;

            statusMessage.className = 'p-4 rounded-md text-red-700 bg-red-50 border border-red-200';
            statusMessage.textContent = 'Network error. Please try again.';
            statusMessage.classList.remove('hidden');
          }
        });
      });

      // Tab switching functions
      function switchMainTab(activeTab) {
        // Hide all sections
        document.querySelectorAll('.section-content').forEach(section => section.classList.add('hidden'));

        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(tab => {
          tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
          tab.classList.add('border-transparent', 'text-gray-500');
        });

        // Show active section and tab
        document.getElementById(activeTab + 'Section').classList.remove('hidden');
        document.getElementById(activeTab + 'Tab').classList.add('active', 'border-blue-500', 'text-blue-600');
        document.getElementById(activeTab + 'Tab').classList.remove('border-transparent', 'text-gray-500');
      }

      function switchPostTab(activeTab) {
        // Hide all post sections
        document.querySelectorAll('.post-content').forEach(section => section.classList.add('hidden'));

        // Remove active class from all post tabs
        document.querySelectorAll('.post-tab-button').forEach(tab => {
          tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
          tab.classList.add('border-transparent', 'text-gray-500');
        });

        // Show active post section and tab
        document.getElementById(activeTab + 'Posts').classList.remove('hidden');
        document.getElementById(activeTab + 'PostsTab').classList.add('active', 'border-blue-500', 'text-blue-600');
        document.getElementById(activeTab + 'PostsTab').classList.remove('border-transparent', 'text-gray-500');
      }

      // Load all posts function
      async function loadAllPosts() {
        const container = document.getElementById('allPostsContent');
        container.innerHTML = '';

        try {
          // Ensure we have a token for authenticated requests
          const token = localStorage.getItem('token');
          if (!token) {
            container.innerHTML = '<div class="col-span-full text-center py-12 text-red-600">Please log in to view your posts</div>';
            return;
          }

          // Fetch all post types concurrently with explicit auth headers
          const headers = { 'Authorization': `Bearer ${token}` };
          const [housingResponse, roommateResponse, activityResponse] = await Promise.all([
            fetch('/api/housing?owner=true', { headers }),
            fetch('/api/roommates?owner=true', { headers }),
            fetch('/api/buddies?owner=true', { headers })
          ]);

          const [housingData, roommateData, activityData] = await Promise.all([
            housingResponse.json(),
            roommateResponse.json(),
            activityResponse.json()
          ]);

          // Combine all posts
          const allPosts = [];

          // Add housing posts
          if (housingData.listings && housingData.listings.length > 0) {
            housingData.listings.forEach(post => {
              allPosts.push({
                type: 'housing',
                data: post,
                title: `${post.property_type} - ${post.rooms} rooms`,
                subtitle: post.address,
                details: `$${post.rent} per month`,
                viewLink: `/housing/${post.id}/view`,
                editLink: `/housing/${post.id}/edit`,
                canDelete: true
              });
            });
          }

          // Add roommate posts
          if (roommateData && roommateData.listings && roommateData.listings.length > 0) {
            roommateData.listings.forEach(post => {
              allPosts.push({
                type: 'roommate',
                data: post,
                title: post.preferred_location,
                subtitle: `$${post.budget_min} - $${post.budget_max} per month`,
                details: post.room_type || 'Any room type',
                viewLink: `/roommates/${post.id}/view`,
                editLink: `/roommates/${post.id}/edit`,
                canDelete: true
              });
            });
          }

          // Add activity posts
          if (activityData && activityData.buddies && activityData.buddies.length > 0) {
            activityData.buddies.forEach(post => {
              allPosts.push({
                type: 'activity',
                data: post,
                title: post.activity_type,
                subtitle: post.location,
                details: new Date(post.date_time).toLocaleDateString(),
                viewLink: `/buddies/${post.id}/view`,
                editLink: `/buddies/${post.id}/edit`,
                canDelete: true
              });
            });
          }

          // Render all posts
          if (allPosts.length > 0) {
            allPosts.forEach(post => {
              const div = document.createElement('div');
              div.className = 'bg-white rounded-lg shadow-md p-4';

              let actionButtons = `
                <div class="flex gap-3">
                  <a href="${post.viewLink}?return_to=profile" class="bg-blue-600 text-white px-3 py-1 rounded-md text-xs font-medium hover:bg-blue-700 transition-colors">
                    View Details
                  </a>
                  ${post.editLink ? `<a href="${post.editLink}?return_to=profile" class="bg-yellow-500 text-white px-3 py-1 rounded-md text-xs font-medium hover:bg-yellow-600 transition-colors">Edit</a>` : ''}
                  ${post.canDelete ? `<button class="bg-red-600 text-white px-3 py-1 rounded-md text-xs font-medium hover:bg-red-700 transition-colors" onclick="deletePost('${post.type}', ${post.data.id})">Delete</button>` : ''}
                </div>
              `;

              div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium px-2 py-1 rounded-full ${
                    post.type === 'housing' ? 'bg-blue-100 text-blue-800' :
                    post.type === 'roommate' ? 'bg-green-100 text-green-800' :
                    'bg-purple-100 text-purple-800'
                  }">${post.type.charAt(0).toUpperCase() + post.type.slice(1)}</span>
                </div>
                <h3 class="font-semibold mb-1">${post.title}</h3>
                <p class="text-sm text-gray-600 mb-1">${post.subtitle}</p>
                <p class="text-sm text-gray-500 mb-3">${post.details}</p>
                <div class="flex justify-between items-center">
                  ${actionButtons}
                </div>
              `;
              container.appendChild(div);
            });
          } else {
            container.innerHTML = `
              <div class="col-span-full">
                <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                  <h3 class="text-lg font-semibold text-red-800 mb-2">No Posts Yet</h3>
                  <p class="text-red-700 mb-6">You haven't created any posts yet. Start sharing your housing, roommate requests, or activities!</p>
                  <div class="flex flex-wrap justify-center gap-4">
                    <a href="/housing/create" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm transition-colors">Create Housing Listing</a>
                    <a href="/roommates/create" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm transition-colors">Create Roommate Request</a>
                    <a href="/buddies/create" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm transition-colors">Create Activity</a>
                  </div>
                </div>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading posts:', error);
          container.innerHTML = '<div class="col-span-full text-center py-12 text-red-600">Error loading your posts</div>';
        }
      }

      async function deletePost(type, id) {
        if (!confirm('Are you sure you want to delete this post?')) return;

        try {
          let endpoint = '';
          if (type === 'housing') endpoint = `/api/housing/${id}`;
          else if (type === 'roommate') endpoint = `/api/roommates/${id}`;
          else if (type === 'activity') endpoint = `/api/buddies/${id}`;

          const response = await fetch(endpoint, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });

          if (response.ok) {
            // Reload all posts
            loadAllPosts();
          } else {
            alert('Failed to delete post');
          }
        } catch (error) {
          alert('Error deleting post');
        }
      }
    </script>
  </body>
</html>
