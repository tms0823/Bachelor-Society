<!-- Sidebar Overlay (Mobile) -->
<div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div id="sidebar" class="fixed left-0 top-0 h-full w-80 bg-gray-900 text-white z-50 sidebar-transition transform lg:transform-none -translate-x-full lg:translate-x-0 shadow-xl">
  <div class="flex flex-col h-full">

    <!-- Logo/Brand -->
    <div class="flex items-center justify-center h-16 bg-gray-800 border-b border-gray-700">
      <span class="text-xl font-bold text-white">Bachelor Society</span>
    </div>

    <!-- Navigation -->
    <div class="flex-1 overflow-y-auto py-4">
      <!-- Home -->
      <div class="mb-6">
        <a href="/dashboard" class="nav-item flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800">
          <i data-lucide="home" class="w-4 h-4"></i>
          <span>Home</span>
        </a>
      </div>

      <!-- My Profile Section -->
      <div class="mb-6">
        <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
          My Profile
        </div>
        <div class="space-y-1">
          <a href="/profile?tab=edit" class="nav-item flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800 ml-4">
            <i data-lucide="edit" class="w-4 h-4"></i>
            <span>Edit Profile</span>
          </a>
          <a href="/profile?tab=posts" class="nav-item flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800 ml-4">
            <i data-lucide="file-text" class="w-4 h-4"></i>
            <span>My Posts</span>
          </a>
        </div>
      </div>

      <!-- Housing Section -->
      <div class="mb-6">
        <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
          Housing
        </div>
        <div class="space-y-1">
          <a href="/housing" class="nav-item flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800 ml-4">
            <i data-lucide="search" class="w-4 h-4"></i>
            <span>Find Housing</span>
          </a>
          <a href="/housing/create" class="nav-item flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800 ml-4">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>Post Listing</span>
          </a>
        </div>
      </div>

      <!-- Roommates Section -->
      <div class="mb-6">
        <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
          Roommates
        </div>
        <div class="space-y-1">
          <a href="/roommates" class="nav-item flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800 ml-4">
            <i data-lucide="users" class="w-4 h-4"></i>
            <span>Find Roommates</span>
          </a>
          <a href="/roommates/create" class="nav-item flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800 ml-4">
            <i data-lucide="user-plus" class="w-4 h-4"></i>
            <span>Create Request</span>
          </a>
        </div>
      </div>

      <!-- Activities Section -->
      <div class="mb-6">
        <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
          Activities
        </div>
        <div class="space-y-1">
          <a href="/buddies" class="nav-item flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800 ml-4">
            <i data-lucide="calendar" class="w-4 h-4"></i>
            <span>Find Activities</span>
          </a>
          <a href="/buddies/create" class="nav-item flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800 ml-4">
            <i data-lucide="plus-circle" class="w-4 h-4"></i>
            <span>Create Activity</span>
          </a>
        </div>
      </div>

      <!-- Messages -->
      <div class="mb-6">
        <a href="/messages" class="nav-item flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800">
          <i data-lucide="message-square" class="w-4 h-4"></i>
          <span>Messages</span>
          <span id="messagesBadge" class="hidden bg-red-500 text-white text-xs px-2 py-1 rounded-full ml-auto">0</span>
        </a>
      </div>
    </div>

    <!-- Logout -->
    <div class="border-t border-gray-700 p-4">
      <button onclick="handleLogout()" class="flex items-center space-x-3 px-2 py-2 text-sm text-red-400 hover:text-red-300 hover:bg-red-900/20 rounded w-full text-left">
        <i data-lucide="log-out" class="w-4 h-4"></i>
        <span>Logout</span>
      </button>
    </div>
  </div>
</div>

<script>
  // Load unread counts for messages
  async function loadUnreadCounts() {
    try {
      // Load messages unread count
      const messagesResponse = await fetch('/api/messages/unread-count', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      if (messagesResponse.ok) {
        const messagesData = await messagesResponse.json();
        updateBadge('messagesBadge', messagesData.unreadCount);
      }
    } catch (error) {
      console.error('Error loading unread counts:', error);
    }
  }

  function updateBadge(badgeId, count) {
    const badge = document.getElementById(badgeId);
    if (count > 0) {
      badge.textContent = count > 99 ? '99+' : count;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }

  // Handle logout
  async function handleLogout() {
    try {
      await logout();
    } catch (error) {
      console.error('Logout failed:', error);
      // Fallback: clear localStorage and redirect anyway
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/login';
    }
  }

  // Load counts when sidebar is loaded
  document.addEventListener('DOMContentLoaded', function() {
    loadUnreadCounts();
    // Refresh counts every 30 seconds
    setInterval(loadUnreadCounts, 30000);
  });
</script>
