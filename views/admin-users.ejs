<div class="max-w-7xl mx-auto">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">User Management</h1>
    <p class="mt-2 text-gray-600">View and manage all user accounts on the platform.</p>
  </div>

  <!-- Search and Filter -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <div class="flex flex-col md:flex-row gap-4">
      <div class="flex-1">
        <input
          type="text"
          id="user-search"
          placeholder="Search users by username or email..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
      </div>
      <div class="flex gap-2">
        <select id="role-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">All Roles</option>
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
        <button onclick="loadUsers()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          <i data-lucide="search" class="w-4 h-4 inline mr-2"></i>
          Search
        </button>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Users (<span id="user-count">0</span>)</h2>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
          <!-- Users will be loaded dynamically -->
        </tbody>
      </table>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="px-6 py-12 text-center">
      <div class="inline-flex items-center">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
        <span class="text-gray-600">Loading users...</span>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden px-6 py-12 text-center">
      <i data-lucide="users" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No users found</h3>
      <p class="text-gray-600">Try adjusting your search criteria.</p>
    </div>
  </div>

  <!-- Pagination -->
  <div id="pagination" class="mt-6 flex justify-center">
    <!-- Pagination will be added dynamically -->
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full p-6">
    <div class="flex items-center mb-4">
      <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-900">Delete User</h3>
    </div>
    <p class="text-gray-600 mb-6">
      Are you sure you want to delete <span id="delete-username" class="font-medium"></span>?
      This action cannot be undone.
    </p>
    <div class="flex gap-3">
      <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
        Cancel
      </button>
      <button id="confirm-delete" onclick="confirmDeleteUser()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
        Delete User
      </button>
    </div>
  </div>
</div>

<script>
let currentUsers = [];
let userToDelete = null;

// Load users with optional search and filter
async function loadUsers(search = '', role = '') {
  const loadingState = document.getElementById('loading-state');
  const emptyState = document.getElementById('empty-state');
  const tableBody = document.getElementById('users-table-body');

  loadingState.classList.remove('hidden');
  emptyState.classList.add('hidden');
  tableBody.innerHTML = '';

  try {
    const response = await fetch('/api/admin/users', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    if (response.ok) {
      const data = await response.json();
      currentUsers = data.users || [];

      // Apply filters
      let filteredUsers = currentUsers;
      if (search) {
        const searchLower = search.toLowerCase();
        filteredUsers = filteredUsers.filter(user =>
          user.username.toLowerCase().includes(searchLower) ||
          user.email.toLowerCase().includes(searchLower)
        );
      }
      if (role) {
        filteredUsers = filteredUsers.filter(user => user.role === role);
      }

      displayUsers(filteredUsers);
    } else {
      console.error('Failed to load users');
      showError('Failed to load users');
    }
  } catch (error) {
    console.error('Error loading users:', error);
    showError('Error loading users');
  }

  loadingState.classList.add('hidden');
}

// Display users in table
function displayUsers(users) {
  const tableBody = document.getElementById('users-table-body');
  const emptyState = document.getElementById('empty-state');
  const userCount = document.getElementById('user-count');

  userCount.textContent = users.length;

  if (users.length === 0) {
    emptyState.classList.remove('hidden');
    return;
  }

  emptyState.classList.add('hidden');

  tableBody.innerHTML = users.map(user => `
    <tr class="hover:bg-gray-50">
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
          <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center mr-3">
            <span class="text-sm font-medium text-gray-700">${user.username.charAt(0).toUpperCase()}</span>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-900">${user.username}</div>
            <div class="text-sm text-gray-500">ID: ${user.id}</div>
          </div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.email}</td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
          user.role === 'admin'
            ? 'bg-red-100 text-red-800'
            : 'bg-blue-100 text-blue-800'
        }">
          ${user.role}
        </span>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        ${new Date(user.created_at).toLocaleDateString()}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
        <button onclick="showDeleteModal(${user.id}, '${user.username}')"
                class="text-red-600 hover:text-red-900 transition-colors"
                ${user.role === 'admin' ? 'disabled class="text-gray-400 cursor-not-allowed"' : ''}>
          <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
          Delete
        </button>
      </td>
    </tr>
  `).join('');

  // Re-initialize icons
  lucide.createIcons();
}

// Show delete confirmation modal
function showDeleteModal(userId, username) {
  userToDelete = userId;
  document.getElementById('delete-username').textContent = username;
  document.getElementById('delete-modal').classList.remove('hidden');
}

// Close delete modal
function closeDeleteModal() {
  userToDelete = null;
  document.getElementById('delete-modal').classList.add('hidden');
}

// Confirm and delete user
async function confirmDeleteUser() {
  if (!userToDelete) return;

  try {
    const response = await fetch(`/api/admin/users/${userToDelete}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    if (response.ok) {
      closeDeleteModal();
      // Reload users
      const searchInput = document.getElementById('user-search').value;
      const roleFilter = document.getElementById('role-filter').value;
      loadUsers(searchInput, roleFilter);
      showSuccess('User deleted successfully');
    } else {
      const error = await response.json();
      showError(error.message || 'Failed to delete user');
    }
  } catch (error) {
    console.error('Error deleting user:', error);
    showError('Error deleting user');
  }
}

// Utility functions for notifications
function showSuccess(message) {
  // You can implement a toast notification system here
  alert(message);
}

function showError(message) {
  // You can implement a toast notification system here
  alert('Error: ' + message);
}

// Event listeners
document.getElementById('user-search').addEventListener('input', function() {
  const search = this.value;
  const role = document.getElementById('role-filter').value;
  loadUsers(search, role);
});

document.getElementById('role-filter').addEventListener('change', function() {
  const search = document.getElementById('user-search').value;
  const role = this.value;
  loadUsers(search, role);
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  loadUsers();
});
</script>
